{% load case_tags %}
{% load hq_shared_tags %}
{% load i18n %}
{% load compress %}

<table class="table table-striped table-bordered"
       data-bind="visible: scheduledReports().length">
  <thead>
    <tr>
      {% if is_owner or is_admin %}
        <th class="col-sm-1">
          {% trans "Bulk Actions" %}
          <button type="button"
                  class="btn btn-xs btn-default"
                  data-bind="click: $root.selectAll">
            {% trans 'All' %}
          </button>
          <button type="button"
                  class="btn btn-xs btn-default"
                  data-bind="click: $root.selectNone">
            {% trans 'None' %}
          </button>
        </th>
      {% endif %}
      {% if not is_owner %}
        <th class="col-sm-2">{% trans "Owner" %}</th>
      {% endif %}
      <th class="{% if is_owner %}col-sm-4{% else %}col-sm-2{% endif %}">{% trans "Reports" %}</th>
      <th class="col-sm-2">{% trans "Day and Time" %}</th>
      <th class="col-sm-2">{% trans "Recipients" %}</th> <!-- buttons too crowded? change to col-sm-1? -->
      <th class="col-sm-4">{% trans "Actions" %}</th>
    </tr>
  </thead>
  <tbody data-bind="foreach: items">
    <tr>

      {% if is_owner or is_admin %}
        <td>
          <div class="checkbox checkbox-table-cell">
            <label>
              <input type="checkbox" data-bind="checked: addedToBulk" />
            </label>
          </div>
        </td>
      {% endif %}

      {% if not is_owner %}
        <td data-bind="text:owner_email"></td>
      {% endif %}

      <td>
        <div data-bind="if: !configMany()">
          <div data-bind="foreach: configs">
            <a data-bind="attr: {href: url}"><span data-bind="text:name"></span> (<span data-bind="text:report_name"></span>)</a>
          </div>
        </div>
        <div data-bind="if: configMany">
          <ul style="float: left">
            <div data-bind="foreach: configs">
              <li ><a data-bind="attr: {href: url}"><span data-bind="text:name"></span> (<span data-bind="text:report_name"></span>)</a></li>
            </div>
          </ul>
        </div>
      </td>

      <td>
        <span data-bind="text: day_name"></span> at <span data-bind="text: hour"></span>:00
      </td>

      <td>
        {# handles old documents #}
        <!-- user_ids MIGHT be deprecated -->
        <div data-bind="if: is_owner">
          <div data-bind="if: send_to_owner"> <!-- || user_ids"> -->
            {% trans "me" %}<span data-bind="if: recipient_email_count">, </span>
          </div>
          <div data-bind="foreach: recipient_emails">
            <span data-bind="text: $data"></span><span data-bind="ifnot: ($index() == ($parent.recipient_emails().length - 1))">, </span>
          </div>
        </div>
        <div data-bind="if: !is_owner">
          <div data-bind="if: !is_admin">
            {% trans "me (and others)" %}
          </div>
          <div data-bind="if: is_admin">
            <div data-bind="if: send_to_owner"> <!-- || user_ids"> -->
              <span data-bind="text: owner_email"></span><span data-bind="if: recipient_emails">,</span>
            </div>
            <div data-bind="foreach: recipient_emails">
              <div data-bind="if: user_email = $data">
                {% trans "me" %}<span data-bind="ifnot: ($index() == ($parent.recipient_emails().length - 1))">, </span>
              </div>
              <div data-bind="if: user_email != $data">
                <span data-bind="text: $data"></span><span data-bind="ifnot: ($index() == ($parent.recipient_emails().length - 1))">, </span>
              </div>
            </div>
          </div>
        </div>
      </td>

      <td>
        <div class="btn-toolbar">
          <div class="btn-group">
            <div data-bind="if: !is_editable || !is_owner && !is_admin">
              <button type="button" class="btn btn-default disabled" disabled="disabled">
                <i class="fa fa-edit"></i> {% trans "Edit" %}
              </button>
            </div>
            <div data-bind="ifnot: !is_editable || !is_owner && !is_admin">
              <a class="btn btn-default"
                 data-bind="attr: {href: editUrl}">
                <i class="fa fa-edit"></i> {% trans "Edit" %}
              </a>
            </div>
          </div>
          <div class="btn-group">
            <a class="btn btn-default"
               data-bind="attr: {href: viewUrl}">
              <i class="fa fa-eye"></i> {% trans "View" %}
            </a>
            <a class="btn btn-default {% if not is_owner and not is_admin %}disabled{% endif %}"
               data-bind="attr: {href: sendUrl}">
              <i class="fa fa-envelope"></i> {% trans "Send Now" %}
            </a>
          </div>

          <div class="btn-group">
            <div data-bind="if: !is_owner && !is_admin">
              <button type="button" class="btn btn-danger disabled" disabled="disabled">
                <i class="fa fa-trash"></i> {% trans "Delete" %}
              </button>
            </div>
            <div data-bind="if: is_owner || is_admin">
              <button class="btn btn-danger" data-toggle="modal" data-bind="attr: {href: '#delete-report-modal-' + id() }">
                <i class="fa fa-trash"></i> {% trans "Delete" %}
              </button>
            </div>
          </div>
          <div class="btn-group">
            <div data-bind="if: !is_owner && !is_admin">
              <a class="btn btn-default" data-bind="attr: {href: unsubscribeUrl}">
                <i class="fa fa-ban"></i> {% trans "Unsubscribe me" %}
              </a>
            </div>
          </div>
        </div>

        <!-- Delete modal -->
        <div data-bind="attr: {id: 'delete-report-modal-' + id() }" class="modal fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">{% trans "Stop sending report?" %}</h4>
              </div>
              <form name="delete_scheduled_report" data-bind="attr: {action: deleteUrl}" method="post"> <!-- don't actually need name? -->
                {% csrf_token %}
                <div class="modal-body">
                  <p>{% trans "Are you sure you want to stop sending this report?" %}</p>
                  <div data-bind="foreach: configs">
                    <div><span data-bind="text:name"></span> (<span data-bind="text:report_name"></span>)</div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" data-dismiss="modal" class="btn btn-default">{% trans "Cancel" %}</button>
                  <button class="send-stopper btn btn-danger disable-on-submit"
                          data-bind="click: deleteScheduledReport">{% trans 'Stop Sending' %}</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Bulk Action Modal (future work) -->

      </td>
    </tr>

  </tbody>
</table>
